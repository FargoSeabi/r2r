{% load static %}
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Secure Checkout — Roots to Realities × PayFast</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.tailwindcss.com"></script>

  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            brand: {
              50:"#fff3ed",100:"#ffe6d9",200:"#fdc9b4",300:"#fba886",400:"#f07e59",
              500:"#e2623f",600:"#cf5536",700:"#b7442b",800:"#953826",900:"#7a2f21"
            }
          },
          boxShadow: {
            card: "0 14px 28px rgba(2, 6, 23, .08)",
          },
          keyframes: {
            shimmer: { '0%': { backgroundPosition: '-468px 0' }, '100%': { backgroundPosition: '468px 0' } },
            pingy: { '0%': { transform: 'scale(1)', opacity: 1 }, '75%, 100%': { transform: 'scale(1.15)', opacity: 0 } }
          },
          animation: {
            shimmer: 'shimmer 1.25s linear infinite',
            pingy: 'pingy 1.4s cubic-bezier(0, 0, .2, 1) infinite'
          }
        }
      }
    }
  </script>

  <style>
    /* Progress bar for countdown */
    #progressBar::before {
      content: "";
      position: absolute;
      inset: 0;
      transform-origin: left;
      transform: scaleX(var(--pc, 1));
      background: linear-gradient(90deg, #e2623f, #f07e59);
      transition: transform .25s linear;
    }
    /* Reduced motion friendly */
    @media (prefers-reduced-motion: reduce) {
      * { animation: none !important; transition: none !important; }
    }
    /* Focus ring for keyboard users */
    :focus-visible { outline: 3px solid #e2623f; outline-offset: 2px; }
  </style>
</head>

<body class="bg-slate-50 text-slate-900">
  <!-- Skip link -->
  <a href="#main" class="sr-only focus:not-sr-only focus:fixed focus:top-3 focus:left-3 bg-white text-slate-900 px-3 py-2 rounded-md shadow">
    Skip to main content
  </a>

  <!-- Header -->
  <header class="bg-gradient-to-r from-slate-900 to-emerald-900 text-white">
    <div class="mx-auto max-w-6xl px-4 sm:px-6 lg:px-8 py-4 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <span class="inline-flex h-10 w-10 items-center justify-center rounded-xl bg-white/10 ring-1 ring-white/20">
          <svg viewBox="0 0 24 24" fill="none" class="h-5 w-5 text-white">
            <path d="M12 2a10 10 0 100 20 10 10 0 000-20Zm0 0v20M2 12h20" stroke="currentColor" stroke-width="1.5" />
          </svg>
        </span>
        <div>
          <div class="font-extrabold tracking-tight">Roots to Realities</div>
          <div class="text-xs text-white/80">VR Experience Checkout</div>
        </div>
      </div>
      <div class="flex items-center gap-2 text-sm">
        <svg class="h-5 w-5 text-emerald-300" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
          <path d="M12 2a10 10 0 00-10 10v4a2 2 0 002 2h1a3 3 0 006 0h2a3 3 0 006 0h1a2 2 0 002-2v-4A10 10 0 0012 2z" />
        </svg>
        <span class="opacity-90">Secure checkout via PayFast</span>
      </div>
    </div>
  </header>

  <!-- Stepper -->
  <div class="mx-auto max-w-6xl px-4 sm:px-6 lg:px-8 mt-6">
    <ol class="flex items-center text-sm text-slate-500 gap-3" aria-label="Checkout steps">
      <li class="flex items-center gap-2">
        <span class="h-6 w-6 grid place-items-center rounded-full bg-emerald-100 text-emerald-700 text-xs font-bold">1</span>
        Review
      </li>
      <li aria-hidden="true">—</li>
      <li class="flex items-center gap-2">
        <span class="h-6 w-6 grid place-items-center rounded-full bg-emerald-100 text-emerald-700 text-xs font-bold">2</span>
        PayFast
      </li>
      <li aria-hidden="true">—</li>
      <li class="flex items-center gap-2 opacity-50">
        <span class="h-6 w-6 grid place-items-center rounded-full bg-slate-200 text-slate-600 text-xs font-bold">3</span>
        Access Granted
      </li>
    </ol>
  </div>

  <main id="main" class="mx-auto max-w-6xl px-4 sm:px-6 lg:px-8 py-8">
    <div class="grid lg:grid-cols-3 gap-8 items-start">
      <!-- Left: Order + Redirect -->
      <section class="lg:col-span-2">
        <div class="bg-white rounded-2xl ring-1 ring-slate-200 shadow-card">
          <div class="p-6 lg:p-8">
            <h1 class="text-2xl sm:text-3xl font-black tracking-tight">Review your order</h1>
            <p class="mt-2 text-slate-600">You’re purchasing access to a <strong>full 360° VR experience</strong>.</p>

            <!-- Summary cards -->
            <div class="mt-6 grid sm:grid-cols-2 gap-4">
              <div class="rounded-xl ring-1 ring-slate-200 p-4">
                <div class="text-sm text-slate-500">Item</div>
                <div class="mt-1 font-semibold">{{ fields.item_name }}</div>
                <div class="mt-1 text-sm text-slate-500 line-clamp-2">{{ fields.item_description }}</div>
              </div>
              <div class="rounded-xl ring-1 ring-slate-200 p-4">
                <div class="text-sm text-slate-500">Amount (ZAR)</div>
                <div class="mt-1 text-2xl font-extrabold text-emerald-700">R {{ fields.amount }}</div>
                <div class="mt-1 text-xs text-slate-500">Tax & fees included if applicable.</div>
              </div>
            </div>

            <!-- PayFast form -->
            <form id="pfForm" method="post" action="{{ payfast_action|default:payfast_url }}" class="mt-6">
              {% for k, v in fields.items %}
                <input type="hidden" name="{{ k }}" value="{{ v|escape }}">
              {% endfor %}
              <input type="hidden" name="signature" value="{{ signature|escape }}">

              <div class="flex flex-wrap items-center gap-3">
                <button id="pfSubmit" type="submit"
                        class="inline-flex items-center justify-center gap-2 px-5 py-3 rounded-xl bg-brand-500 hover:bg-brand-600 text-white font-semibold shadow focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-brand-500 focus-visible:ring-offset-2">
                  Continue to PayFast
                  <svg viewBox="0 0 24 24" class="h-5 w-5" fill="none" stroke="currentColor" stroke-width="1.5">
                    <path d="M5 12h14M13 5l7 7-7 7" />
                  </svg>
                </button>

                <button type="button"
                        class="px-4 py-3 rounded-xl border border-slate-200 text-slate-700 hover:bg-slate-50"
                        onclick="history.back()">
                  Cancel
                </button>

                <div class="text-xs text-slate-500 flex items-center gap-2">
                  <svg class="h-4 w-4" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><path d="M12 2a10 10 0 00-10 10v4a2 2 0 002 2h1a3 3 0 006 0h2a3 3 0 006 0h1a2 2 0 002-2v-4A10 10 0 0012 2z"/></svg>
                  Protected by PayFast — we do not store your card details.
                </div>
              </div>
            </form>

            <p class="mt-6 text-xs text-slate-500">
              By continuing, you agree to the purchase terms. You’ll be returned here after payment.
            </p>
          </div>
        </div>

        <!-- Trust / FAQ row -->
        <div class="mt-6 grid sm:grid-cols-3 gap-4 text-sm">
          <div class="bg-white rounded-xl ring-1 ring-slate-200 p-4">
            <div class="font-semibold">Secure</div>
            <div class="text-slate-600 mt-1">256-bit TLS · PCI DSS via PayFast.</div>
          </div>
          <div class="bg-white rounded-xl ring-1 ring-slate-200 p-4">
            <div class="font-semibold">Support</div>
            <div class="text-slate-600 mt-1">Need help? Email support@rootstorealities.com</div>
          </div>
          <div class="bg-white rounded-xl ring-1 ring-slate-200 p-4">
            <div class="font-semibold">Refunds</div>
            <div class="text-slate-600 mt-1">Eligible within 14 days if unused.</div>
          </div>
        </div>
      </section>

      <!-- Right: Village card -->
      <aside class="space-y-4">
        <div class="bg-white rounded-2xl overflow-hidden ring-1 ring-slate-200 shadow-card">
          <div class="relative h-44 bg-slate-100">
            <img
              src="{{ village.hero_image|default:'' }}"
              alt="{{ village.name|default:'Village image' }}"
              class="w-full h-full object-cover"
              onerror="this.src='https://images.unsplash.com/photo-1500534314209-a25ddb2bd429?q=80&w=1600&auto=format&fit=crop';"
            />
          </div>
          <div class="p-5">
            <div class="text-sm text-slate-500">Village</div>
            <div class="mt-1 font-semibold">{{ village.name|default:"Selected Village" }}</div>
            <div class="mt-1 text-sm text-slate-600">
              {% if village.region %}{{ village.region }}{% endif %}
              {% if village.country %}{% if village.region %}, {% endif %}{{ village.country }}{% endif %}
            </div>
          </div>
        </div>

        <div class="bg-white rounded-2xl ring-1 ring-slate-200 p-5">
          <div class="font-semibold">What you’ll get</div>
          <ul class="mt-3 space-y-2 text-sm text-slate-600">
            <li class="flex gap-2"><span>✅</span> Full 360° VR village experience</li>
            <li class="flex gap-2"><span>✅</span> Unlimited replays for 48 hours</li>
            <li class="flex gap-2"><span>✅</span> Support local creators</li>
          </ul>
        </div>
      </aside>
    </div>
  </main>

  <footer class="py-10">
    <div class="mx-auto max-w-6xl px-4 sm:px-6 lg:px-8 text-sm text-slate-500 flex items-center justify-between">
      <div>© <span id="year"></span> Roots to Realities</div>
      <div class="flex items-center gap-4">
        <span>Privacy</span>
        <span>Terms</span>
        <span>Support</span>
      </div>
    </div>
  </footer>

  <!-- Chatbot Widget -->
  <div id="chatToggle" class="fixed bottom-6 right-6 z-50 bg-brand-500 hover:bg-brand-600 text-white rounded-full p-4 shadow-lg cursor-pointer transition-all duration-300 hover:scale-105">
    <svg id="chatIcon" class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
    </svg>
    <svg id="closeIcon" class="w-6 h-6 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
    </svg>
  </div>

  <div id="chatWindow" class="fixed bottom-24 right-6 z-50 w-80 bg-white rounded-lg shadow-xl border border-slate-200 hidden flex-col max-h-96">
    <!-- Chat Header -->
    <div class="bg-brand-500 text-white p-4 rounded-t-lg">
      <div class="flex items-center gap-2">
        <div class="h-8 w-8 bg-white/20 rounded-full flex items-center justify-center">
          <span class="text-sm">💳</span>
        </div>
        <div>
          <h3 class="font-semibold text-sm">Checkout Support</h3>
          <p class="text-xs text-brand-100">Need help with your order?</p>
        </div>
      </div>
    </div>

    <!-- Chat Messages -->
    <div id="chatMessages" class="flex-1 p-4 space-y-3 overflow-y-auto max-h-48">
      <div class="flex gap-2">
        <div class="h-6 w-6 bg-brand-100 rounded-full flex items-center justify-center flex-shrink-0">
          <span class="text-xs">💳</span>
        </div>
        <div class="bg-slate-100 rounded-lg p-3 max-w-xs">
          <p class="text-sm">I'm here to help with your checkout process. Ask about payment, security, or your order!</p>
        </div>
      </div>
    </div>

    <!-- Quick Replies -->
    <div class="p-3 border-t border-slate-100">
      <div class="flex flex-wrap gap-2 mb-3">
        <button class="quick-reply bg-slate-100 hover:bg-slate-200 text-slate-700 px-3 py-1 rounded-full text-xs transition">Payment Help</button>
        <button class="quick-reply bg-slate-100 hover:bg-slate-200 text-slate-700 px-3 py-1 rounded-full text-xs transition">Security</button>
        <button class="quick-reply bg-slate-100 hover:bg-slate-200 text-slate-700 px-3 py-1 rounded-full text-xs transition">Order Details</button>
      </div>
    </div>

    <!-- Chat Input -->
    <div class="p-3 border-t border-slate-100">
      <div class="flex gap-2">
        <input id="chatInput" type="text" placeholder="Ask about checkout..." class="flex-1 border border-slate-200 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-brand-500 focus:border-transparent">
        <button id="sendMessage" class="bg-brand-500 hover:bg-brand-600 text-white rounded-lg px-4 py-2 text-sm transition">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path>
          </svg>
        </button>
      </div>
    </div>
  </div>

  <script>
    // Set current year
    document.getElementById('year').textContent = new Date().getFullYear();
    
    // Chatbot functionality
    (() => {
        const chatToggle = document.getElementById('chatToggle');
        const chatWindow = document.getElementById('chatWindow');
        const chatIcon = document.getElementById('chatIcon');
        const closeIcon = document.getElementById('closeIcon');
        const chatMessages = document.getElementById('chatMessages');
        const chatInput = document.getElementById('chatInput');
        const sendButton = document.getElementById('sendMessage');
        const quickReplies = document.querySelectorAll('.quick-reply');
        
        let isOpen = false;
        
        // Checkout-specific responses
        const responses = {
            'payment': 'We use PayFast for secure payment processing. All major credit cards, debit cards, and EFT are accepted. Your payment information is encrypted and secure.',
            'security': 'Your checkout is protected by SSL encryption and PayFast\'s secure payment gateway. We never store your card details on our servers.',
            'order': 'Your order includes full 360° VR village experience with unlimited replays for 48 hours. You\'ll receive access details via email after payment.',
            'help': 'Having trouble? Try refreshing the page or contact our support team. Your session is saved and you can complete payment anytime.',
            'refund': 'We offer full refunds within 24 hours if you experience technical issues. Contact support with your order details for assistance.',
            'access': 'After successful payment, you\'ll receive an email with your VR access link and instructions. Access is valid for 48 hours from purchase.',
            'technical': 'For technical issues during checkout, try clearing your browser cache or using a different browser. Contact support if problems persist.',
            'time': 'Your checkout session is secure and won\'t expire. Take your time to review your order before completing payment.',
            'support': 'Need immediate help? Email hello@rootstorealities.co.za or use the contact form on our main website.',
            'default': 'I can help with payment questions, security concerns, or order details. What would you like to know about your checkout?'
        };
        
        function toggleChat() {
            isOpen = !isOpen;
            if (isOpen) {
                chatWindow.classList.remove('hidden');
                chatWindow.classList.add('flex');
                chatIcon.classList.add('hidden');
                closeIcon.classList.remove('hidden');
                chatInput.focus();
            } else {
                chatWindow.classList.add('hidden');
                chatWindow.classList.remove('flex');
                chatIcon.classList.remove('hidden');
                closeIcon.classList.add('hidden');
            }
        }
        
        function addMessage(message, isUser = false) {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'flex gap-2' + (isUser ? ' justify-end' : '');
            
            if (isUser) {
                messageDiv.innerHTML = `
                    <div class="bg-brand-500 text-white rounded-lg p-3 max-w-xs">
                        <p class="text-sm">${message}</p>
                    </div>
                `;
            } else {
                messageDiv.innerHTML = `
                    <div class="h-6 w-6 bg-brand-100 rounded-full flex items-center justify-center flex-shrink-0">
                        <span class="text-xs">💳</span>
                    </div>
                    <div class="bg-slate-100 rounded-lg p-3 max-w-xs">
                        <p class="text-sm">${message}</p>
                    </div>
                `;
            }
            
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
        
        function getResponse(message) {
            const lowerMessage = message.toLowerCase();
            
            if (lowerMessage.includes('payment') || lowerMessage.includes('pay') || lowerMessage.includes('card') || lowerMessage.includes('payfast')) {
                return responses.payment;
            } else if (lowerMessage.includes('security') || lowerMessage.includes('secure') || lowerMessage.includes('safe') || lowerMessage.includes('ssl')) {
                return responses.security;
            } else if (lowerMessage.includes('order') || lowerMessage.includes('purchase') || lowerMessage.includes('buy')) {
                return responses.order;
            } else if (lowerMessage.includes('help') || lowerMessage.includes('problem') || lowerMessage.includes('issue')) {
                return responses.help;
            } else if (lowerMessage.includes('refund') || lowerMessage.includes('cancel') || lowerMessage.includes('money back')) {
                return responses.refund;
            } else if (lowerMessage.includes('access') || lowerMessage.includes('email') || lowerMessage.includes('link')) {
                return responses.access;
            } else if (lowerMessage.includes('technical') || lowerMessage.includes('error') || lowerMessage.includes('browser')) {
                return responses.technical;
            } else if (lowerMessage.includes('time') || lowerMessage.includes('expire') || lowerMessage.includes('session')) {
                return responses.time;
            } else if (lowerMessage.includes('support') || lowerMessage.includes('contact')) {
                return responses.support;
            } else {
                return responses.default;
            }
        }
        
        function sendMessage() {
            const message = chatInput.value.trim();
            if (!message) return;
            
            addMessage(message, true);
            chatInput.value = '';
            
            setTimeout(() => {
                const response = getResponse(message);
                addMessage(response, false);
            }, 500);
        }
        
        // Event listeners
        chatToggle.addEventListener('click', toggleChat);
        sendButton.addEventListener('click', sendMessage);
        chatInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });
        
        // Quick reply buttons
        quickReplies.forEach(button => {
            button.addEventListener('click', () => {
                const message = button.textContent;
                addMessage(message, true);
                setTimeout(() => {
                    const response = getResponse(message);
                    addMessage(response, false);
                }, 500);
            });
        });
    })();
  </script>

</body>
</html>
